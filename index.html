<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa Family</title>
  <style>
    body {
      background: url('family.jpeg') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      text-align: center;
      color: white;
      padding: 20px;
    }
    input, textarea, button {
      padding: 10px;
      margin: 5px;
      border-radius: 10px;
      border: none;
    }
    #participants {
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 15px;
      display: inline-block;
    }
    #adminBtn {
      background: crimson;
      color: white;
      cursor: pointer;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ… Secret Santa - Family Arango Mantilla Verkeyn ğŸ</h1>
  <p>Enter your info below (name, email, and gift idea)</p>

  <div>
    <input type="text" id="name" placeholder="Name / Nombre / Naam"><br>
    <input type="email" id="email" placeholder="Email"><br>
    <textarea id="gift" placeholder="Gift idea / DescripciÃ³n del regalo"></textarea><br>
    <button id="submitBtn">Submit / Enviar / Versturen</button>
  </div>

  <h2>Participants Registered</h2>
  <div id="participants"></div>
  <p id="count"></p>

  <button id="adminBtn" style="display:none;">Forzar envÃ­o de correos</button>

  <script type="module">
    // --- Firebase config ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, push, get, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxpOQHSZdLr4kdPvhH3bBRKw6p1ywPYIE",
      authDomain: "santa-secreto-d2f26.firebaseapp.com",
      projectId: "santa-secreto-d2f26",
      storageBucket: "santa-secreto-d2f26.firebasestorage.app",
      messagingSenderId: "447417641195",
      appId: "1:447417641195:web:f38a2adaca6d5ea91cb6ae",
      databaseURL: "https://santa-secreto-d2f26-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const participantsRef = ref(db, 'participants');

    // --- EmailJS config ---
    import emailjs from "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    emailjs.init("SGuCPgvO1PEEQ3zTz");

    // --- Register participant ---
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const gift = document.getElementById("gift").value.trim();

      if (!name || !email || !gift) {
        alert("Please fill all fields!");
        return;
      }

      await push(participantsRef, { name, email, gift });
      alert("Registered successfully!");
      document.getElementById("name").value = "";
      document.getElementById("email").value = "";
      document.getElementById("gift").value = "";
    });

    // --- Show participants (only names) ---
    onValue(participantsRef, (snapshot) => {
      const data = snapshot.val();
      const participantsDiv = document.getElementById("participants");
      const count = document.getElementById("count");
      participantsDiv.innerHTML = "";
      let total = 0;

      if (data) {
        for (let key in data) {
          participantsDiv.innerHTML += `<p>ğŸ„ ${data[key].name}</p>`;
          total++;
        }
      }

      count.innerText = `Total registered: ${total}`;
    });

    // --- Admin mode ---
    const nameInput = document.getElementById("name");
    nameInput.addEventListener("input", () => {
      if (nameInput.value.trim().toLowerCase() === "famamv") {
        document.getElementById("adminBtn").style.display = "inline-block";
      }
    });

    // --- Admin: send emails manually ---
    document.getElementById("adminBtn").addEventListener("click", async () => {
      const snapshot = await get(participantsRef);
      if (!snapshot.exists()) {
        alert("No participants found.");
        return;
      }

      const data = Object.values(snapshot.val());
      if (data.length < 2) {
        alert("Need at least 2 participants to send.");
        return;
      }

      // --- Random pairing without self or duplicates ---
      let shuffled = [...data];
      let isValid = false;
      while (!isValid) {
        shuffled.sort(() => Math.random() - 0.5);
        isValid = shuffled.every((p, i) => p.email !== data[i].email);
      }

      const pairs = data.map((giver, i) => ({
        giver,
        receiver: shuffled[i]
      }));

      for (let pair of pairs) {
        const params = {
          to_name: pair.giver.name,
          from_name: "Secret Santa Family ğŸ…",
          message: `Hi ${pair.giver.name}! ğŸ You are the Secret Santa for ${pair.receiver.name}.
Gift idea of your person: ${pair.receiver.gift}`,
          to_email: pair.giver.email
        };

        try {
          await emailjs.send("service_x20t9vh", "template_yla91y2", params);
          console.log(`Email sent to ${pair.giver.name}`);
        } catch (e) {
          console.error("Error sending email:", e);
        }
      }

      alert("All Secret Santa emails have been sent successfully!");
    });
  </script>
</body>
</html>
