<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ… Secret Santa - Family Arango Mantilla Verkeyn ğŸ</title>
  <style>
    body {
      background: url('family.jpeg') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      text-align: center;
      color: white;
      margin: 0;
      padding: 30px;
    }

    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    input, textarea, button {
      margin: 5px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }

    textarea {
      resize: none;
      width: 250px;
      height: 60px;
    }

    #participants {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      display: inline-block;
      padding: 15px;
      margin-top: 20px;
    }

    #adminBtn {
      display: none;
      background: crimson;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 20px;
    }

    #count {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ… Secret Santa 2025 ğŸ</h1>
  <p>Enter your name, email and gift idea below</p>

  <div>
    <input id="name" type="text" placeholder="Name / Nombre / Naam" /><br>
    <input id="email" type="email" placeholder="Email" /><br>
    <textarea id="gift" placeholder="Gift idea / DescripciÃ³n del regalo"></textarea><br>
    <button id="submitBtn">Submit / Enviar / Versturen</button>
  </div>

  <div id="participants"></div>
  <p id="count"></p>

  <button id="adminBtn">ğŸ… Force Secret Santa Email Send</button>

  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, push, get, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBxpOQHSZdLr4kdPvhH3bBRKw6p1ywPYIE",
      authDomain: "santa-secreto-d2f26.firebaseapp.com",
      databaseURL: "https://santa-secreto-d2f26-default-rtdb.firebaseio.com/",
      projectId: "santa-secreto-d2f26",
      storageBucket: "santa-secreto-d2f26.firebasestorage.app",
      messagingSenderId: "447417641195",
      appId: "1:447417641195:web:f38a2adaca6d5ea91cb6ae"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const participantsRef = ref(db, "participants");

    // --- EmailJS ---
    import emailjs from "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";
    emailjs.init("SGuCPgvO1PEEQ3zTz");

    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const giftInput = document.getElementById("gift");
    const participantsDiv = document.getElementById("participants");
    const countP = document.getElementById("count");
    const adminBtn = document.getElementById("adminBtn");

    // --- Registrar participante ---
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const gift = giftInput.value.trim();

      if (!name || !email || !gift) {
        alert("Please fill all fields!");
        return;
      }

      await push(participantsRef, { name, email, gift });
      alert("Registered successfully!");
      nameInput.value = "";
      emailInput.value = "";
      giftInput.value = "";
    });

    // --- Mostrar nombres ---
    onValue(participantsRef, (snapshot) => {
      const data = snapshot.val();
      participantsDiv.innerHTML = "";
      let total = 0;

      if (data) {
        for (let key in data) {
          participantsDiv.innerHTML += `<p>ğŸ„ ${data[key].name}</p>`;
          total++;
        }
      }

      countP.textContent = `Total registered: ${total}`;
    });

    // --- Modo admin (escribiendo famamv) ---
    nameInput.addEventListener("input", () => {
      if (nameInput.value.trim().toLowerCase() === "famamv") {
        adminBtn.style.display = "inline-block";
      }
    });

    // --- BotÃ³n admin: enviar correos ---
    adminBtn.addEventListener("click", async () => {
      const snapshot = await get(participantsRef);
      if (!snapshot.exists()) {
        alert("No participants found.");
        return;
      }

      const participants = Object.values(snapshot.val());
      if (participants.length < 2) {
        alert("Need at least 2 participants to assign.");
        return;
      }

      // Mezclar receptores evitando que alguien se saque a sÃ­ mismo
      let receivers;
      do {
        receivers = [...participants].sort(() => Math.random() - 0.5);
      } while (receivers.some((r, i) => r.email === participants[i].email));

      // Enviar correo a cada participante
      for (let i = 0; i < participants.length; i++) {
        const giver = participants[i];
        const receiver = receivers[i];

        const params = {
          to_name: giver.name,
          from_name: "Secret Santa ğŸ…",
          to_email: giver.email,
          message: `Hi ${giver.name}! ğŸ You are the Secret Santa for ${receiver.name}.
Gift idea they mentioned: ${receiver.gift}`
        };

        try {
          await emailjs.send("service_x20t9vh", "template_yla91y2", params);
          console.log(`âœ… Email sent to ${giver.name}`);
        } catch (e) {
          console.error(`âŒ Error sending email to ${giver.name}:`, e);
        }
      }

      alert("ğŸ„ All Secret Santa emails have been sent successfully!");
    });
  </script>
</body>
</html>
