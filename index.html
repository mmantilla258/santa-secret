<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Santa - Familia AMV</title>
  <style>
    *{box-sizing:border-box;font-family:Arial, sans-serif}
    body{margin:0;padding:20px;background:url('family.jpeg') center/cover no-repeat;color:#fff;text-align:center;}
    .card{background:rgba(0,0,0,0.55);padding:16px;border-radius:12px;display:inline-block;min-width:300px}
    input,textarea,button{width:90%;padding:10px;margin:8px 0;border-radius:8px;border:none;font-size:14px}
    textarea{height:80px;resize:none}
    button{cursor:pointer;background:#e63946;color:#fff}
    .small{font-size:13px;color:#ddd}
    #participantsBox{margin-top:12px;background:rgba(255,255,255,0.08);padding:10px;border-radius:8px;text-align:left;max-height:250px;overflow:auto}
    .admin-btn{display:none;margin:6px;padding:10px;border-radius:8px;border:none}
    #resetBtn{background:#ff4444;color:#fff}
    #sendManualBtn{background:#00796b;color:#fff}
    #log{margin-top:10px;font-size:12px;color:#eee;white-space:pre-wrap;text-align:left;max-width:90%;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h2>üéÖ Secret Santa ‚Äî Familia Arango-Mantilla-Verkeyn</h2>
    <p class="small">Escribe tu nombre / Email / Descripci√≥n del regalo (Nombre 'famamv' muestra admin)</p>

    <form id="form">
      <input id="name" type="text" placeholder="Name / Nombre / Naam" required />
      <input id="email" type="email" placeholder="Email / Correo / E-mail" required />
      <textarea id="wish" placeholder="Gift description / Descripci√≥n del regalo / Beschrijving"></textarea>
      <button id="submitBtn" type="submit">Enviar / Send</button>
    </form>

    <div id="status" class="small"></div>

    <div id="participantsBox"><strong>Participantes:</strong><div id="participantsList" style="margin-top:8px"></div></div>

    <div id="adminArea" style="margin-top:12px">
      <button id="resetBtn" class="admin-btn">üîÅ Reiniciar sistema</button>
      <button id="sendManualBtn" class="admin-btn">üì® Enviar correos manualmente</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- Firebase v8 (sin m√≥dulos) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- EmailJS classic -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>

  <script>
  // -------------- CONFIG ----------------
  const EMAILJS_PUBLIC_KEY = "SGuCPgvO1PEEQ3zTz";
  const EMAILJS_SERVICE_ID = "service_x20t9vh";
  const EMAILJS_TEMPLATE_ID = "template_yla91y2";

  // Firebase config (tu proyecto)
  const firebaseConfig = {
    apiKey: "AIzaSyBxpOQHSZdLr4kdPvhH3bBRKw6p1ywPYIE",
    authDomain: "santa-secreto-d2f26.firebaseapp.com",
    databaseURL: "https://santa-secreto-d2f26-default-rtdb.firebaseio.com",
    projectId: "santa-secreto-d2f26",
    storageBucket: "santa-secreto-d2f26.firebasestorage.app",
    messagingSenderId: "447417641195",
    appId: "1:447417641195:web:f38a2adaca6d5ea91cb6ae"
  };
  // -------------- END CONFIG ------------

  // Init Firebase (v8)
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const participantsRef = db.ref('participantes'); // la ruta exacta en tu RTDB

  // Init EmailJS
  emailjs.init(EMAILJS_PUBLIC_KEY);

  // DOM
  const form = document.getElementById('form');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const wishInput = document.getElementById('wish');
  const participantsList = document.getElementById('participantsList');
  const status = document.getElementById('status');
  const resetBtn = document.getElementById('resetBtn');
  const sendManualBtn = document.getElementById('sendManualBtn');
  const adminArea = document.getElementById('adminArea');
  const logEl = document.getElementById('log');

  // Helper log
  function log(msg){
    console.log(msg);
    logEl.textContent = (new Date()).toLocaleTimeString() + " ‚Äî " + msg + "\n" + logEl.textContent;
  }

  // State cache
  let participantsCache = {}; // key -> {nombre, correo, regalo}

  // Show participants in DOM
  function renderParticipants(){
    const keys = Object.keys(participantsCache);
    if(keys.length === 0){
      participantsList.innerHTML = "<i>No hay participantes a√∫n</i>";
      status.textContent = "";
      return;
    }
    let html = "<ol style='padding-left:16px;margin:0'>";
    keys.forEach(k=>{
      const p = participantsCache[k];
      const safeName = (p.nombre||"").replace(/[<>]/g,'');
      const safeWish = (p.regalo||"").replace(/[<>]/g,'');
      html += `<li><strong>${safeName}</strong> ‚Äî <span class='small'>${safeWish}</span></li>`;
    });
    html += "</ol>";
    participantsList.innerHTML = html;
    status.textContent = `${keys.length} / 11 registrados`;
  }

  // Listen realtime
  participantsRef.on('value', snapshot => {
    const val = snapshot.val();
    participantsCache = val || {};
    log("Datos Firebase recibidos. Registros: " + Object.keys(participantsCache).length);
    renderParticipants();
  }, error => {
    log("Error lectura Firebase: " + (error && error.message));
  });

  // Add participant
  form.addEventListener('submit', e=>{
    e.preventDefault();
    const nombre = nameInput.value.trim();
    const correo = emailInput.value.trim();
    const regalo = wishInput.value.trim();
    if(!nombre || !correo) {
      alert("Completa nombre y correo.");
      return;
    }
    // push
    participantsRef.push({ nombre, correo, regalo })
      .then(()=> {
        log(`Registro agregado: ${nombre} <${correo}>`);
        form.reset();
      })
      .catch(err=>{
        log("Error push: " + err.message);
      });
  });

  // Admin detection (famamv)
  nameInput.addEventListener('input', ()=>{
    const v = nameInput.value.trim().toLowerCase();
    if(v === 'famamv'){
      resetBtn.style.display = 'inline-block';
      sendManualBtn.style.display = 'inline-block';
      log("Modo admin activado (famamv).");
    } else {
      resetBtn.style.display = 'none';
      sendManualBtn.style.display = 'none';
    }
  });

  // Reset DB (admin)
  resetBtn.addEventListener('click', ()=>{
    if(!confirm("¬øSeguro que quieres borrar TODOS los registros?")) return;
    participantsRef.remove()
      .then(()=> {
        log("Base de datos limpiada por admin.");
        alert("Sistema reiniciado.");
      })
      .catch(err => {
        log("Error al borrar: " + err.message);
        alert("Error al reiniciar: " + err.message);
      });
  });

  // Utility: generar asignacion tipo derangement (1:1, nadie se repite ni se autoasigna)
  function generarDerangement(arr){
    // arr = array de objetos; devuelve array de pares {santa, destinatario}
    if(arr.length < 2) return null;
    const n = arr.length;
    // clon
    let indices = Array.from({length:n}, (_,i)=>i);
    let ok = false;
    let tries = 0;
    let shuffled;
    while(!ok && tries < 2000){
      tries++;
      shuffled = indices.slice().sort(()=>Math.random()-0.5);
      ok = true;
      for(let i=0;i<n;i++){
        if(shuffled[i] === i){ ok = false; break; }
      }
    }
    if(!ok) return null;
    const result = arr.map((santa,i)=>({
      santa,
      destinatario: arr[shuffled[i]]
    }));
    return result;
  }

  // Send emails (admin button) ‚Äî NO automatic
  sendManualBtn.addEventListener('click', async ()=>{
    try{
      const arr = Object.values(participantsCache);
      if(arr.length !== 11){
        alert("La acci√≥n requiere exactamente 11 participantes. Actualmente: " + arr.length);
        return;
      }
      if(!confirm("Enviar correos a los 11 participantes ahora?")) return;

      log("Generando asignaciones...");
      const asign = generarDerangement(arr);
      if(!asign){
        alert("Error generando asignaciones, int√©ntalo de nuevo.");
        log("Derangement fall√≥.");
        return;
      }

      // enviar uno por uno (esperando para evitar l√≠mites)
      for(let i=0;i<asign.length;i++){
        const par = asign[i];
        const to_email = par.santa.correo;
        const to_name = par.santa.nombre;
        const secret_name = par.destinatario.nombre;
        const secret_gift = par.destinatario.regalo || "";

        // template fields: aseg√∫rate que en EmailJS use to_email, to_name, secret_friend, secret_gift
        const templateParams = {
          to_name: to_name,
          to_email: to_email,
          secret_friend: secret_name,
          secret_gift: secret_gift
        };

        try{
          // emailjs.send(serviceID, templateID, templateParams)
          await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
          log(`Enviado: ${to_name} -> ${secret_name} (${to_email})`);
        }catch(err){
          log("Error envio EmailJS a " + to_name + ": " + (err && err.text ? err.text : err));
        }

        // corta espera para no saturar (200ms)
        await new Promise(r => setTimeout(r, 200));
      }

      alert("Correos enviados (revisa EmailJS logs).");
      log("Proceso de env√≠o terminado.");
    }catch(err){
      log("Error en enviarManual: " + (err && err.message ? err.message : err));
    }
  });

  // -------------- DEBUG / Instrucciones para ti --------------
  log("Script cargado. Esperando datos de Firebase...");
  log("Comprueba la consola (F12) si algo falla.");
  </script>
</body>
</html>
